<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0">
  <title>Match de Génie en Herbe</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- IndexedDB helpers -->
  <script src="idb.js"></script>

  <!-- Font Inter -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
    rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
    .quiz-card { background-color: #161b22; border: 1px solid #30363d; }
    .timer-ring { animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .correct-feedback { background-color: #238636; border-color: #3f6e4a; }
    .incorrect-feedback { background-color: #da3633; border-color: #8c3b3b; }
    .summary-correct { color: #238636; font-weight: 700; }
    .summary-incorrect { color: #da3633; font-weight: 700; }
    .pause-overlay { backdrop-filter: blur(8px); }
  </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col items-center justify-center">

  <h1 class="text-4xl md:text-5xl font-extrabold mb-8 text-white text-center">
    Match de Génie en Herbe
  </h1>

  <main id="app-container" class="w-full max-w-4xl">
    <!-- Contenu de l'application rendu par JavaScript -->
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
    <div id="modal-content" class="p-6 rounded-lg shadow-2xl w-11/12 max-w-lg text-center quiz-card">
      <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
      <p id="modal-message" class="mb-6 text-lg"></p>
      <div class="flex justify-center space-x-4">
        <button id="modal-button" class="px-6 py-2 rounded-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 transition duration-150">Continuer</button>
        <button id="modal-cancel-button" class="hidden px-6 py-2 rounded-lg font-semibold text-white bg-gray-600 hover:bg-gray-700 transition duration-150">Annuler</button>
      </div>
    </div>
  </div>

  <!-- App script (Firebase + IndexedDB hybride) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, setDoc, getDocs, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuration (peut être injectée ou écrite en dur)
    const firebaseConfig = typeof __firebase_config !== 'undefined'
      ? JSON.parse(__firebase_config)
      : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-quiz-app';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;

    // Initialisation Firebase (unique)
    async function initFirebase() {
      if (!firebaseConfig) return;
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      if (initialAuthToken) {
        await signInWithCustomToken(auth, initialAuthToken);
      } else {
        await signInAnonymously(auth);
      }
      gameState.userId = getUserId();
      gameState.isAuthReady = true;
      setupLeaderboardListener();
    }

    function getPublicScoresCollectionRef() {
      // Chemin simplifié et stable
      return collection(db, "scores");
    }

    // État global
    let gameState = {
      view: 'login',
      userName: '',
      userFirstName: '',
      userId: null,
      currentScore: 0,
      currentQIndex: 0,
      timer: 0,
      initialTimer: 15,
      timerInterval: null,
      leaderboard: [],
      isAuthReady: false,
      isPaused: false,
      userAnswers: []
    };

    function getUserId() {
      const uid = auth?.currentUser?.uid
        || (typeof crypto !== 'undefined' ? crypto.randomUUID()
        : 'anonymous-' + Math.random().toString(36).substring(2, 9));
      return uid;
    }

    // Modal helper
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalMessage = document.getElementById('modal-message');
    const modalButton = document.getElementById('modal-button');
    const modalCancelButton = document.getElementById('modal-cancel-button');

    function showModal(title, message, callback, cancelCallback = null) {
      modalTitle.textContent = title;
      modalMessage.innerHTML = message;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      modalButton.textContent = cancelCallback ? "Confirmer" : "Continuer";
      modalButton.onclick = () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        if (callback) callback();
      };
      if (cancelCallback) {
        modalCancelButton.classList.remove('hidden');
        modalCancelButton.textContent = "Annuler";
        modalCancelButton.onclick = () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          cancelCallback();
        };
      } else {
        modalCancelButton.classList.add('hidden');
      }
    }
    // IndexedDB integration (uses idb.js)
    async function saveScoreLocal() {
      if (!gameState.userId) {
        gameState.userId = (typeof crypto !== 'undefined'
          ? crypto.randomUUID()
          : 'anonymous-' + Math.random().toString(36).substring(2, 9));
      }
      const entry = {
        id: (typeof crypto !== 'undefined' ? crypto.randomUUID() : 'score-' + Date.now()),
        userId: gameState.userId,
        name: `${gameState.userFirstName} ${gameState.userName}`.trim() || '(Sans nom)',
        score: gameState.currentScore,
        timestamp: Date.now()
      };
      try {
        await idbPut('scores', entry);
      } catch (e) {
        console.error('IDB save error:', e);
      }
      if (!navigator.onLine || !gameState.isAuthReady) {
        try {
          await idbPut('syncQueue', entry);
        } catch (e) {
          console.error('IDB enqueue error:', e);
        }
      }
    }

    async function getLocalLeaderboard(limitCount = 10) {
      const scores = await idbGetAll('scores');
      const bestByUser = new Map();
      for (const s of scores) {
        const prev = bestByUser.get(s.userId);
        if (!prev || s.score > prev.score) bestByUser.set(s.userId, s);
      }
      return Array.from(bestByUser.values())
        .sort((a,b) => b.score - a.score || (b.timestamp - a.timestamp))
        .slice(0, limitCount);
    }

    window.addEventListener('online', async () => {
      if (firebaseConfig && !gameState.isAuthReady) {
        await initFirebase();
      }
      try {
        const pending = await idbGetAll('syncQueue');
        for (const entry of pending) {
          try {
            const userRef = doc(getPublicScoresCollectionRef(), entry.id);
            await setDoc(userRef, {
              id: entry.id,
              userId: entry.userId,
              name: entry.name,
              score: entry.score,
              timestamp: serverTimestamp()
            }, { merge: true });
            await idbDelete('syncQueue', entry.id);
          } catch (e) {
            console.error('Sync error for entry', entry.id, e);
          }
        }
      } catch (e) {
        console.error('SyncQueue read error:', e);
      }
      renderApp();
    });

    window.addEventListener('offline', () => {
      console.info('Mode hors ligne — classement local uniquement');
    });

    // Quiz data (extrait; garde ta structure complète)
    const RAW_QUIZ_DATA = {
      "Duel des capitaines": [
        { points: 20, question: "Écrivain britannique d'origine indienne... Quel est le nom de cette œuvre ?", answer: "Les versets sataniques" },
        { points: 20, question: "Dans quel pays peut-on visiter Man, Daloa, Gagnoa et Korhogo ?", answer: "la Côte d'Ivoire" },
        { points: 20, question: "Médecin et criminaliste italien... ?", answer: "Cesare LOMBROSO" }
      ],
      "Éclairs (Série 1)": [
        { points: 10, question: "Burj Khalifa: combien d'étages ?", answer: "164 étages" },
        { points: 10, question: "Maladie due au manque de B1 ?", answer: "Béri-béri" }
      ]
      // ... (tes autres rubriques inchangées)
    };

    const SHUFFLEABLE_SECTIONS = [
      "Duel des capitaines",
      "Éclairs (Série 1)"
      // ... (tes autres rubriques)
    ];

    let QUIZ_DATA_FINAL = [];
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    for (const sectionName of Object.keys(RAW_QUIZ_DATA)) {
      let questions = [...RAW_QUIZ_DATA[sectionName]];
      if (SHUFFLEABLE_SECTIONS.includes(sectionName)) {
        questions = shuffleArray(questions);
      }
      questions.forEach(q => {
        QUIZ_DATA_FINAL.push({ ...q, section: sectionName });
      });
    }

    // Leaderboard utils
    async function getRemoteLeaderboard(max = 10) {
      if (!gameState.isAuthReady) return [];
      const q = query(getPublicScoresCollectionRef(), orderBy('score', 'desc'), limit(max));
      const snap = await getDocs(q);
      const arr = [];
      snap.forEach(docu => {
        const d = docu.data();
        arr.push({
          userId: d.userId || d.id,
          name: d.name,
          score: d.score,
          timestamp: (d.timestamp?.seconds ? d.timestamp.seconds * 1000 : Date.now())
        });
      });
      return arr;
    }

    async function getCombinedLeaderboard(max = 10) {
      const local = await getLocalLeaderboard(max);
      if (navigator.onLine && gameState.isAuthReady) {
        const remote = await getRemoteLeaderboard(max);
        const map = new Map();
        for (const r of remote) map.set(r.userId, r);
        for (const l of local) {
          const existing = map.get(l.userId);
          if (!existing || l.score > existing.score) map.set(l.userId, l);
        }
        return Array.from(map.values())
          .sort((a,b) => b.score - a.score || (b.timestamp - a.timestamp))
          .slice(0, max);
      } else {
        return local;
      }
    }

    function renderLeaderboardSection(items) {
      const listItems = items.map((item, index) => `
        <li class="flex justify-between items-center py-3 px-4 rounded-lg ${index < 3 ? 'bg-yellow-900/50 border-l-4 border-yellow-400' : 'bg-gray-800'} ${item.userId === gameState.userId ? 'ring-2 ring-blue-500' : ''}">
          <span class="font-bold w-10 text-center">${index + 1}</span>
          <span class="flex-grow text-left">${item.name || '(Anonyme)'} <span class="text-xs text-gray-500">ID: ${(item.userId || '').substring(0, 8)}...</span> ${item.userId === gameState.userId ? '(Vous)' : ''}</span>
          <span class="font-extrabold text-yellow-300">${item.score} Pts</span>
        </li>
      `).join('');
      return `
        <div class="mt-10 p-6 quiz-card rounded-xl shadow-2xl w-full">
          <h2 class="text-3xl font-bold mb-6 text-white text-center">Classement des Génies (Top 10)</h2>
          <ul class="space-y-2 text-lg">
            ${listItems.length > 0 ? listItems : '<p class="text-center text-gray-500">Aucun score enregistré pour l\'instant.</p>'}
          </ul>
          ${(!navigator.onLine || !gameState.isAuthReady) ? '<p class="mt-3 text-center text-sm text-gray-400">(Mode hors ligne ou Firestore indisponible: classement local)</p>' : ''}
        </div>
      `;
    }
    async function renderLeaderboard() {
      const items = await getCombinedLeaderboard(10);
      const container = document.getElementById("app-container");
      container.innerHTML = renderLeaderboardSection(items);
    }

    // Rendu des vues
    function renderLoginView() {
      const container = document.getElementById("app-container");
      container.innerHTML = `
        <div class="quiz-card p-6 rounded-lg">
          <h2 class="text-xl font-bold mb-4">Entrez votre prénom et nom</h2>
          <input id="firstNameInput" class="w-full p-2 rounded mb-4 text-black" placeholder="Prénom">
          <input id="nameInput" class="w-full p-2 rounded mb-4 text-black" placeholder="Nom">
          <button id="startBtn" class="px-4 py-2 bg-green-600 text-white rounded">Commencer</button>
          <div id="leaderboard-container" class="mt-6"></div>
        </div>
      `;
      document.getElementById("startBtn").onclick = () => {
        gameState.userFirstName = document.getElementById("firstNameInput").value || "";
        gameState.userName = document.getElementById("nameInput").value || "Anonyme";
        gameState.userId = getUserId();
        gameState.currentScore = 0;
        gameState.currentQIndex = 0;
        gameState.userAnswers = [];
        gameState.view = 'quiz';
        renderApp();
      };
      // Charger classement
      (async () => {
        const lbHTML = await renderLeaderboardSection(await getCombinedLeaderboard(10));
        document.getElementById("leaderboard-container").innerHTML = lbHTML;
      })();
    }

    function renderQuizView() {
      const q = QUIZ_DATA_FINAL[gameState.currentQIndex];
      const container = document.getElementById("app-container");
      container.innerHTML = `
        <div class="quiz-card p-6 rounded-lg">
          <h2 class="text-xl font-bold mb-4">Question ${gameState.currentQIndex+1} (${q.section})</h2>
          <p class="mb-4">${q.question}</p>
          <input id="answerInput" class="w-full p-2 rounded mb-4 text-black" placeholder="Votre réponse">
          <button id="submitBtn" class="px-4 py-2 bg-blue-600 text-white rounded">Valider</button>
        </div>
      `;
      document.getElementById("submitBtn").onclick = () => {
        const userAnswer = document.getElementById("answerInput").value;
        const isCorrect = userAnswer.trim().toLowerCase() === q.answer.toLowerCase();
        if (isCorrect) gameState.currentScore += q.points;
        gameState.userAnswers.push({
          question: q.question,
          userAnswer,
          correctAnswer: q.answer,
          isCorrect,
          points: q.points
        });
        gameState.currentQIndex++;
        if (gameState.currentQIndex < QUIZ_DATA_FINAL.length) {
          renderQuizView();
        } else {
          endQuiz();
        }
      };
    }

    async function endQuiz() {
      await saveScoreLocal();
      if (navigator.onLine && gameState.isAuthReady && gameState.currentScore > 0) {
        try {
          const userRef = doc(getPublicScoresCollectionRef(), gameState.userId);
          await setDoc(userRef, {
            id: gameState.userId,
            name: `${gameState.userFirstName} ${gameState.userName}`.trim(),
            score: gameState.currentScore,
            timestamp: serverTimestamp()
          }, { merge: true });
        } catch (e) {
          console.error('Firestore save failed, enqueue for later:', e);
          await idbPut('syncQueue', {
            id: crypto.randomUUID(),
            userId: gameState.userId,
            name: `${gameState.userFirstName} ${gameState.userName}`.trim(),
            score: gameState.currentScore,
            timestamp: Date.now()
          });
        }
      }
      gameState.view = 'results';
      renderApp();
    }

    function renderResultsView() {
      const container = document.getElementById("app-container");
      const answersHTML = gameState.userAnswers.map((a, i) => `
        <li class="mb-2">
          <span class="${a.isCorrect ? 'summary-correct' : 'summary-incorrect'}">
            Q${i+1}: ${a.question}
          </span><br>
          Votre réponse: ${a.userAnswer} | Bonne réponse: ${a.correctAnswer}
        </li>
      `).join('');
      container.innerHTML = `
        <div class="quiz-card p-6 rounded-lg">
          <h2 class="text-2xl font-bold mb-4">Résultats</h2>
          <p class="mb-4">Score final: ${gameState.currentScore} points</p>
          <ul>${answersHTML}</ul>
          <div id="leaderboard-container" class="mt-6"></div>
          <button class="mt-4 px-4 py-2 bg-green-600 text-white rounded" onclick="renderLoginView()">Rejouer</button>
        </div>
      `;
      (async () => {
        const lbHTML = await renderLeaderboardSection(await getCombinedLeaderboard(10));
        document.getElementById("leaderboard-container").innerHTML = lbHTML;
      })();
    }

    function renderApp() {
      if (gameState.view === 'login') renderLoginView();
      else if (gameState.view === 'quiz') renderQuizView();
      else if (gameState.view === 'results') renderResultsView();
    }

    window.onload = async () => {
      if (firebaseConfig) {
        await initFirebase();
      } else {
        console.warn("Firebase config not found. Running in local mode.");
        gameState.isAuthReady = false;
      }
      renderApp();
    };
  </script>
</body>
</html>
